
{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞–º–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">
            <i class="fas fa-medal text-warning me-2 glow-effect"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞–º–∏
        </h2>
        <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
        </a>
    </div>

    <!-- Create Badge Form -->
    <div class="admin-form-card mb-4">
        <h4 class="text-warning mb-3">
            <i class="fas fa-plus-circle me-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–µ–π–¥–∂
        </h4>
        <form method="POST" action="{{ url_for('create_badge') }}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">–°–∏—Å—Ç–µ–º–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" name="name" required 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: champion_badge">
                    <div class="form-text">–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" name="display_name" required 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–µ–º–ø–∏–æ–Ω">
                </div>
                <div class="col-12">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-control" name="description" rows="2" 
                              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –±–µ–π–¥–∂–∞"></textarea>
                </div>
                <div class="col-md-4">
                    <label class="form-label">–ò–∫–æ–Ω–∫–∞ (Font Awesome)</label>
                    <input type="text" class="form-control" name="icon" value="fas fa-medal" 
                           placeholder="fas fa-medal">
                </div>
                <div class="col-md-4">
                    <label class="form-label">–≠–º–æ–¥–∑–∏ (—Ç–µ–∫—Å—Ç)</label>
                    <input type="text" class="form-control" name="emoji" 
                           placeholder="üèÜ" maxlength="10">
                </div>
                <div class="col-md-4">
                    <label class="form-label">–ö–∞—Å—Ç–æ–º–Ω—ã–π —ç–º–æ–¥–∑–∏ (URL)</label>
                    <input type="text" class="form-control" name="emoji_url" 
                           placeholder="https://example.com/emoji.png">
                </div>
                <div class="col-md-4">
                    <label class="form-label">–†–µ–¥–∫–æ—Å—Ç—å</label>
                    <select class="form-select" name="rarity">
                        <option value="common">–û–±—ã—á–Ω—ã–π</option>
                        <option value="rare">–†–µ–¥–∫–∏–π</option>
                        <option value="epic">–≠–ø–∏—á–µ—Å–∫–∏–π</option>
                        <option value="legendary">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</option>
                        <option value="mythic">–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
                    <input type="color" class="form-control form-control-color" name="color" value="#ffffff">
                </div>
                <div class="col-md-6">
                    <label class="form-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                    <input type="color" class="form-control form-control-color" name="background_color" value="#343a40">
                </div>
                <div class="col-md-6">
                    <label class="form-label">–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
                    <input type="color" class="form-control form-control-color" name="border_color" value="#ffd700">
                </div>
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="has_gradient" id="hasGradient" onchange="toggleGradientFields()">
                        <label class="form-check-label" for="hasGradient">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç
                        </label>
                    </div>
                </div>
                <div class="col-md-6" id="gradientStart" style="display: none;">
                    <label class="form-label">–ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</label>
                    <input type="color" class="form-control form-control-color" name="gradient_start" value="#ffd700">
                </div>
                <div class="col-md-6" id="gradientEnd" style="display: none;">
                    <label class="form-label">–ö–æ–Ω–µ—á–Ω—ã–π —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</label>
                    <input type="color" class="form-control form-control-color" name="gradient_end" value="#ffaa00">
                </div>
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_animated" id="isAnimated">
                        <label class="form-check-label" for="isAnimated">
                            –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–µ–π–¥–∂
                        </label>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –±–µ–π–¥–∂
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Assign Badge Form -->
    <div class="admin-form-card mb-4">
        <h4 class="text-info mb-3">
            <i class="fas fa-user-plus me-2"></i>–ü—Ä–∏—Å–≤–æ–∏—Ç—å –±–µ–π–¥–∂ –∏–≥—Ä–æ–∫—É
        </h4>
        <form method="POST" action="{{ url_for('assign_badge') }}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">–ò–≥—Ä–æ–∫</label>
                    <select class="form-select" name="player_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>
                        {% for player in players %}
                        <option value="{{ player.id }}">{{ player.nickname }} (–£—Ä–æ–≤–µ–Ω—å {{ player.level }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">–ë–µ–π–¥–∂</label>
                    <select class="form-select" name="badge_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–µ–π–¥–∂</option>
                        {% for stat in badge_stats %}
                        {% if stat.badge.is_active %}
                        <option value="{{ stat.badge.id }}">{{ stat.badge.display_name }} ({{ stat.assigned_count }} –∏–≥—Ä–æ–∫–æ–≤)</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-award me-2"></i>–ü—Ä–∏—Å–≤–æ–∏—Ç—å –±–µ–π–¥–∂
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Existing Badges -->
    <div class="admin-form-card">
        <h4 class="text-primary mb-3">
            <i class="fas fa-list me-2"></i>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–µ–π–¥–∂–∏
        </h4>
        
        {% if badge_stats %}
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead class="table-warning">
                    <tr>
                        <th>–ü—Ä–µ–≤—å—é</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–†–µ–¥–∫–æ—Å—Ç—å</th>
                        <th>–ò–≥—Ä–æ–∫–æ–≤</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–æ–∑–¥–∞–Ω</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in badge_stats %}
                    {% set badge = stat.badge %}
                    <tr>
                        <td>
                            <div class="badge-preview">
                                <span class="player-badge rarity-{{ badge.rarity }} {{ 'animated-badge' if badge.is_animated else '' }}"
                                      style="{% if badge.has_gradient and badge.gradient_start and badge.gradient_end %}background: linear-gradient(45deg, {{ badge.gradient_start }}, {{ badge.gradient_end }});{% else %}background-color: {{ badge.background_color }};{% endif %} color: {{ badge.color }}; border-color: {{ badge.border_color }};">
                                    <i class="{{ badge.icon }}"></i>
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold">{{ badge.display_name }}</div>
                            <div class="text-muted small">{{ badge.name }}</div>
                        </td>
                        <td>
                            <span class="text-muted">{{ badge.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</span>
                        </td>
                        <td>
                            <span class="badge rarity-{{ badge.rarity }}">{{ badge.rarity.title() }}</span>
                        </td>
                        <td>
                            <span class="text-info fw-bold">{{ stat.assigned_count }}</span>
                        </td>
                        <td>
                            <span class="badge {{ 'bg-success' if badge.is_active else 'bg-danger' }}">
                                {{ '–ê–∫—Ç–∏–≤–µ–Ω' if badge.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                            </span>
                        </td>
                        <td class="text-muted small">
                            {{ badge.created_at.strftime('%d.%m.%Y') }}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" 
                                        onclick="toggleBadgeStatus({{ badge.id }}, {{ badge.is_active|lower }})"
                                        title="{{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if badge.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}">
                                    <i class="fas {{ 'fa-eye-slash' if badge.is_active else 'fa-eye' }}"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-medal fa-3x text-muted mb-3"></i>
            <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±–µ–π–¥–∂–µ–π</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleGradientFields() {
    const hasGradient = document.getElementById('hasGradient').checked;
    const gradientStart = document.getElementById('gradientStart');
    const gradientEnd = document.getElementById('gradientEnd');
    
    if (hasGradient) {
        gradientStart.style.display = 'block';
        gradientEnd.style.display = 'block';
    } else {
        gradientStart.style.display = 'none';
        gradientEnd.style.display = 'none';
    }
}

function toggleBadgeStatus(badgeId, currentStatus) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${currentStatus ? '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} —ç—Ç–æ—Ç –±–µ–π–¥–∂?`)) {
        fetch(`/admin/toggle_badge/${badgeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–π–¥–∂–∞');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–π–¥–∂–∞');
        });
    }
}

// Animate badge preview
document.querySelectorAll('.badge-preview').forEach((preview, index) => {
    setTimeout(() => {
        preview.style.animation = 'fadeInUp 0.6s ease';
    }, index * 100);
});
</script>
{% endblock %}
